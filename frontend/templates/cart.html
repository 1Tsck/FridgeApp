{% extends 'base.html' %}{% block content %}
<h2 style="text-align:left; color:#2193b0; margin-bottom:1.5rem;">Shopping Cart</h2>
<div class="table-container">
    <table id="cartTable" class="styled-table">
        <thead>
            <tr>
                <th onclick="sortTable(0)">Item</th>
                <th onclick="sortTable(1, true)">Quantity</th>
                <th onclick="sortTable(2)">Unit</th>
                <th onclick="sortTable(3)">User</th>
                <th>Modify quantity</th>
                <th>Modify unit</th>
                <th style="text-align: center;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% for c in cart %}
            <tr>
                <td>{{ typesDict.get(c.type_id).name }}</td>
                <td style="text-align: right;">{{ c.quantity }}</td>
                <td>{{ c.unit }}</td>
                <td>{{ c.user }}</td>
                <form method='post' action='/cart/item/update' class="inline-form">
                    <input type="hidden" name="cart_id" value="{{ c.id }}">
                    <td><input name="quantity" value="{{ c.quantity }}" class="input-field"></td>
                    <td><select name="unit" value="{{ c.unit }}" class="input-field">
                                <option value="">-- Select the unit --</option>
                                <option value="Pieces" {% if c.unit == "Pieces" %} selected {% endif %}>Pieces</option>
                                <option value="Kilograms" {% if c.unit == "Kilograms" %} selected {% endif %}>Kilograms</option>
                                <option value="Grams" {% if c.unit == "Grams" %} selected {% endif %}>Grams</option>
                                <option value="Litres" {% if c.unit == "Litres" %} selected {% endif %}>Litres</option>
                                <option value="Mililitres" {% if c.unit == "Mililitres" %} selected {% endif %}>Mililitres</option>
                        </select>
                    </td>
                    <td class="actions">
                        <button type="submit" class="action-button update-button">Save</button>
                </form>
                <form action="/cart/item/delete" method="post" class="delete-form inline-form"> 
                    <input type="hidden" name="cart_id" value="{{ c.id }}"> 
                    <button type="submit" class="action-button delete-button">Delete</button> 
                </form> 
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<h3 style="margin-top:2rem; color:#2193b0;">Add new cart item</h3>
<form method='post' id="addItemForm" action='/cart/item/create' class="add-form">
    <select id="add_item_item_type_id" name="add_item_item_type_id" required class="add-item-form-select small-input">
        <option value="">-- Select item type --</option>
        {% for type in types %}
        <option value="{{ type.id }}">{{ type.name }} ({{ type.description }})</option>
        {% endfor %}
    </select>
    <input type="number" id="add_item_quantity" name="add_item_quantity" placeholder="Quantity" required class="input-field small-input">
    <select type="text" id="add_item_unit" name="add_item_unit" placeholder="Unit" required class="input-field small-input">
        <option value="">-- Select the unit --</option>
        <option value="Pieces">Pieces</option>
        <option value="Kilograms">Kilograms</option>
        <option value="Grams">Grams</option>
        <option value="Litres">Litres</option>
        <option value="Mililitres">Mililitres</option>
    </select>
    <button type="submit" class="action-button update-button">Add</button>
</form>
<!-- delete item confirmation -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const forms = document.querySelectorAll(".delete-form");

        forms.forEach(form => {
            form.addEventListener("submit", function(event) {
                event.preventDefault(); // Stop normal submit

                Swal.fire({
                    title: "Are you sure you want to delete the item?",
                    text: "This item will be permanently deleted.",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, delete it!",
                    cancelButtonText: "Cancel"
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit(); // Proceed with form submission
                    }
                });
            });
        });
    });
</script>
<!-- sortable table -->
 <script>
document.addEventListener('DOMContentLoaded', function () {
    // Automatically sort the table by column 0 (first column)
    // Set `numeric = true` if sorting numbers
    sortTable(0, false);
});
</script>
<script>
function sortTable(columnIndex, numeric = false) {
    const table = document.getElementById("cartTable");
    const tbody = table.tBodies[0];
    const rows = Array.from(tbody.querySelectorAll("tr"));
    const headers = table.querySelectorAll("th");

    // Toggle sort direction
    const currentSort = table.dataset.sortColumn == columnIndex;
    const ascending = !currentSort || table.dataset.sortDirection === "desc";

    // Sort rows
    rows.sort((a, b) => {
        let valA = a.children[columnIndex].innerText.trim();
        let valB = b.children[columnIndex].innerText.trim();

        if (numeric) {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
        }

        if (valA < valB) return ascending ? -1 : 1;
        if (valA > valB) return ascending ? 1 : -1;
        return 0;
    });

    // Rebuild table body
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));

    // Update sort metadata
    table.dataset.sortColumn = columnIndex;
    table.dataset.sortDirection = ascending ? "asc" : "desc";

    // Clear previous active sort indicators
    headers.forEach((th, i) => {
        th.removeAttribute("data-sorted");
        if (i === columnIndex) {
            th.setAttribute("data-sorted", ascending ? "asc" : "desc");
        }
    });
}
</script>
{% endblock %}